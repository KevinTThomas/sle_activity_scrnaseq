Analysis 04: Analysis and clustering
================
Kevin Thomas
20 January, 2022

-   [Initial analysis of QC’d cells](#initial-analysis-of-qcd-cells)
    -   [Normalization](#normalization)
-   [Harmony on PC](#harmony-on-pc)
-   [Weighted nearest neighbors (wnn)
    analysis](#weighted-nearest-neighbors-wnn-analysis)
-   [Clustering](#clustering)

## Initial analysis of QC’d cells

``` r
qc_object <- readRDS(file = here("demo_data", "qc_object.RDS"))
```

### Normalization

``` r
# Reduce available cores to ensure sufficient memory per core
plan(strategy = multisession, workers = ceiling(0.25 * parallel::detectCores()))
# SCTransform normalization. Regress out mitochondrial content,
# hemoglobin content, differences in Ig subclass, and cell cycle phase
normalized_object <- SCTransform(
  object = qc_object,
  assay = "RNA",
  vars.to.regress =
    c(
      "percent_mt",
      "percent_hemo",
      grep(
        pattern = "[.]diff$",
        x = names(qc_object[[]]),
        value = TRUE
      )
    ),
  method = "glmGamPoi"
)
```

    ## Calculating cell attributes from input UMI matrix: log_umi

    ## Variance stabilizing transformation of count matrix of size 17584 by 13231

    ## Model formula is y ~ log_umi

    ## Get Negative Binomial regression parameters per gene

    ## Using 2000 genes, 5000 cells

    ##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |==========================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |  25%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |===================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |  50%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                          |  75%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%

    ## Found 119 outliers - those will be ignored in fitting/regularization step

    ## Second step: Get residuals using fitted parameters for 17584 genes

    ##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |=================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |   3%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |==================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |   6%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |===================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |   8%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |====================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |  11%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |=====================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |  14%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |======================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |  17%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |=======================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |  19%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |========================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  22%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |==========================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |  25%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |===========================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |  28%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |============================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |  31%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |=============================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |  33%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |==============================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |  36%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |  39%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |  42%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |  44%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |==================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |  47%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |===================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |  50%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |  53%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |  56%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |  58%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |  61%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                              |  64%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                             |  67%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |==========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                            |  69%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                           |  72%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                          |  75%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                        |  78%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                       |  81%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                      |  83%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                     |  86%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |==================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                    |  89%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |===================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                   |  92%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                  |  94%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                 |  97%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%

    ## Computing corrected count matrix for 17584 genes

    ##   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |   0%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |=================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |   3%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |==================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |   6%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |===================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |   8%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |====================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |  11%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |=====================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |  14%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |======================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |  17%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |=======================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |  19%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |========================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  22%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |==========================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |  25%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |===========================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |  28%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |============================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |  31%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |=============================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |  33%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |==============================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |  36%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |  39%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |  42%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |  44%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |==================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |  47%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |===================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |  50%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |  53%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |  56%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |  58%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |  61%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                              |  64%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                             |  67%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |==========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                                                            |  69%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                                                           |  72%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                                                          |  75%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                                                        |  78%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                                                       |  81%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                                                      |  83%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                                                     |  86%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |==================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                                                    |  89%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |===================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                                                   |  92%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                                                  |  94%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================                                 |  97%  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================| 100%

    ## Calculating gene attributes

    ## Wall clock passed: Time difference of 56.39646 secs

    ## Determine variable features

    ## Place corrected count matrix in counts slot

    ## Regressing out percent_mt, percent_hemo, IGHA1.IGHA2.diff, IGHA1.IGHG1.diff, IGHA1.IGHG2.diff, IGHA1.IGHG3.diff, IGHA1.IGHG4.diff, IGHA1.IGHGP.diff, IGHA1.IGHD.diff, IGHA1.IGHE.diff, IGHA1.IGHM.diff, IGHA2.IGHG1.diff, IGHA2.IGHG2.diff, IGHA2.IGHG3.diff, IGHA2.IGHG4.diff, IGHA2.IGHGP.diff, IGHA2.IGHD.diff, IGHA2.IGHE.diff, IGHA2.IGHM.diff, IGHG1.IGHG2.diff, IGHG1.IGHG3.diff, IGHG1.IGHG4.diff, IGHG1.IGHGP.diff, IGHG1.IGHD.diff, IGHG1.IGHE.diff, IGHG1.IGHM.diff, IGHG2.IGHG3.diff, IGHG2.IGHG4.diff, IGHG2.IGHGP.diff, IGHG2.IGHD.diff, IGHG2.IGHE.diff, IGHG2.IGHM.diff, IGHG3.IGHG4.diff, IGHG3.IGHGP.diff, IGHG3.IGHD.diff, IGHG3.IGHE.diff, IGHG3.IGHM.diff, IGHG4.IGHGP.diff, IGHG4.IGHD.diff, IGHG4.IGHE.diff, IGHG4.IGHM.diff, IGHGP.IGHD.diff, IGHGP.IGHE.diff, IGHGP.IGHM.diff, IGHD.IGHE.diff, IGHD.IGHM.diff, IGHE.IGHM.diff, IGLC1.IGLC2.diff, IGLC1.IGLC3.diff, IGLC1.IGLC5.diff, IGLC1.IGLC6.diff, IGLC1.IGLC7.diff, IGLC1.IGKC.diff, IGLC2.IGLC3.diff, IGLC2.IGLC5.diff, IGLC2.IGLC6.diff, IGLC2.IGLC7.diff, IGLC2.IGKC.diff, IGLC3.IGLC5.diff, IGLC3.IGLC6.diff, IGLC3.IGLC7.diff, IGLC3.IGKC.diff, IGLC5.IGLC6.diff, IGLC5.IGLC7.diff, IGLC5.IGKC.diff, IGLC6.IGLC7.diff, IGLC6.IGKC.diff, IGLC7.IGKC.diff, cc.diff

    ## Centering data matrix

    ## Set default assay to SCT

``` r
# Reset paralellization
plan(strategy = multisession, workers = parallel::detectCores())
```

## Harmony on PC

``` r
# Clear and free up memory
rm(qc_object)
gc()
```

    ##            used  (Mb) gc trigger   (Mb)   max used   (Mb)
    ## Ncells  6357680 339.6   11137002  594.8    8107529  433.0
    ## Vcells 87141082 664.9  859586722 6558.2 1059885493 8086.3

``` r
# Run PCA and harmonize on normalized gene expression and CITE expression
harmonized_object <- normalized_object |>
  RunPCA() |>
  FindPCAElbow(
    assay = "SCT",
    perform_new_pca = FALSE,
    elbow_th = 0.025
  ) |>
  RunHarmony(
    group.by.vars = c("run"),
    assay.use = "SCT",
    dims.use = 1:50
  ) |>
  ScaleData(
    assay = "CITE"
  ) |>
  `DefaultAssay<-`(
    value = "CITE"
  ) %>%
  RunPCA(
    features = rownames(.)[rownames(.) != "isotype-control"],
    reduction.name = "pca_cite",
    reduction.key = "citePCA_"
  ) |>
  FindPCAElbow(
    assay = "CITE",
    reduction = "pca_cite",
    perform_new_pca = FALSE,
    elbow_th = 0.025
  ) |>
  RunHarmony(
    group.by.vars = c("run"),
    assay.use = "CITE",
    reduction = "pca_cite",
    dims.use = 1:50,
    reduction.save = "harmony_cite"
  ) |>
  `DefaultAssay<-`(
    value = "SCT"
  )
```

    ## PC_ 1 
    ## Positive:  GNLY, NKG7, CCL5, KLRB1, CD247, GZMA, CMC1, GZMB, KLRF1, CTSW 
    ##     CD7, CST7, PRKCH, FGFBP2, PRF1, IL32, KLRD1, SPON2, HOPX, GZMH 
    ##     SKAP1, TRDC, IFITM1, B2M, CLIC3, TRBC1, GZMM, NCALD, STAT4, RUNX3 
    ## Negative:  S100A8, LYZ, S100A9, AC020656.1, FTL, FOS, S100A12, TEX14, VCAN, MNDA 
    ##     FCN1, FTH1, S100A6, AIF1, CCDC200, NAMPT, CST3, NEAT1, CTSS, S100A4 
    ##     DUSP1, SRGN, AP1S2, LST1, TYROBP, ACTB, DPYD, ANXA1, CD36, CSTA 
    ## PC_ 2 
    ## Positive:  S100A8, LYZ, GNLY, AC020656.1, S100A9, NKG7, S100A12, CCL5, GZMA, KLRB1 
    ##     FOS, KLRF1, CD247, VCAN, CMC1, CTSW, MNDA, TEX14, CST7, FGFBP2 
    ##     GZMB, CD7, PRF1, SPON2, SRGN, CCDC200, KLRD1, PRKCH, HOPX, GZMH 
    ## Negative:  RPS27, CD74, RPS19, RPS18, RPS6, RPL10, RPL21, RPS29, FTH1, LTB 
    ##     RPL13A, AFF3, HLA-DPB1, RPL34, RPS27A, RPL18A, CD52, RPL3, BANK1, RPL13 
    ##     HLA-DRA, HLA-DPA1, BACH2, ANGPTL1, AC120193.1, JCHAIN, TCF4, SNX9, LST1, RPL39 
    ## PC_ 3 
    ## Positive:  PPBP, TMSB4X, PF4, GNG11, FTH1, HIST1H2AC, CAVIN2, FTL, RGS18, ACTB 
    ##     ACRBP, CCL5, CMTM5, NRGN, TMEM40, TUBB1, CLU, AIF1, LST1, NCOA4 
    ##     GFI1B, TSC22D1, GP9, SAT1, MAP3K7CL, ITGA2B, BEX3, CTTN, PTCRA, C19orf33 
    ## Negative:  LYZ, AC020656.1, S100A8, RPS27, AFF3, S100A9, BACH2, RPS18, RPS29, RPL13 
    ##     RPL34, RPS6, RPL3, RPL13A, BANK1, RPL21, RPS27A, LTB, CD69, ANGPTL1 
    ##     AC120193.1, RPL18A, BCL2, S100A12, RPL10, RPL39, LINC01619, RHOH, FCHSD2, TCF4 
    ## PC_ 4 
    ## Positive:  PPBP, LYZ, PF4, GNG11, AC020656.1, HIST1H2AC, CAVIN2, RGS18, CMTM5, ACRBP 
    ##     S100A8, TMEM40, CCL5, NRGN, TUBB1, PTCRA, TSC22D1, CLU, BEX3, GFI1B 
    ##     GP9, ITGA2B, NCOA4, MAP3K7CL, JCHAIN, C19orf33, RUFY1, SMIM5, CTTN, AC127502.2 
    ## Negative:  FTL, FTH1, AIF1, LST1, GNLY, S100A4, FCGR3A, FCER1G, IFITM3, ACTB 
    ##     S100A11, SAT1, TCF7L2, IFITM2, S100A6, TYROBP, IFI30, CST3, PSAP, LGALS1 
    ##     CRIP1, SMIM25, HLA-DPA1, CTSS, NEAT1, B2M, APOBEC3A, MT2A, CALM2, LY6E 
    ## PC_ 5 
    ## Positive:  S100A8, S100A9, S100A12, MNDA, S100A4, VCAN, S100A6, IL1R2, RPS27, TEX14 
    ##     FCN1, ANXA1, RETN, FOS, CSTA, CD36, RPL34, SELL, RPS29, RPL39 
    ##     RPL21, NCF1, AC253572.2, RPL13A, RPS18, CD14, RBP7, AC245014.3, RFLNB, RPL3 
    ## Negative:  LYZ, AC020656.1, CYBB, IFI6, EIF5A, AC022217.3, C1orf56, CDC42SE1, FTH1, FGD2 
    ##     HNRNPH1, AP001160.1, SAT1, NEAT1, IFITM3, AIF1, AC092069.1, B4GALT1, FTL, ZEB2 
    ##     SLC8A1, MTA2, LST1, CLEC7A, TCF7L2, CTNNB1, HLA-DPA1, RASSF3, FCGR3A, HLA-DPB1

    ## Harmony 1/10

    ## Harmony 2/10

    ## Harmony 3/10

    ## Harmony 4/10

    ## Harmony 5/10

    ## Harmony converged after 5 iterations

    ## Warning: Invalid name supplied, making object name syntactically valid. New object name is Seurat..ProjectDim.SCT.harmony; see ?make.names for more details on syntax validity

    ## Centering and scaling data matrix

    ## Warning in irlba(A = t(x = object), nv = npcs, ...): You're computing too large a percentage of total singular values, use a standard svd instead.

    ## Warning: Requested number is larger than the number of available items (51). Setting to 51.

    ## Warning: Requested number is larger than the number of available items (51). Setting to 51.

    ## Warning: Requested number is larger than the number of available items (51). Setting to 51.

    ## Warning: Requested number is larger than the number of available items (51). Setting to 51.

    ## Warning: Requested number is larger than the number of available items (51). Setting to 51.

    ## citePCA_ 1 
    ## Positive:  CD268, CD19, CD185, CD21, CD24, IgD, CD40, CD1c, CD307c, CD27 
    ##     CD307e, CD70, CD94, CD154, HLA-DR, CD10, CD117, CD85j, CD80, CD127 
    ##     CD307d, CD135, CD56, CD8a, CD209, CD269 
    ## Negative:  CD11b, CD11c, CD64, CD86, CD95, CD14, CD58, CD4, CD366, CD1d 
    ##     CD305, CD267, CD69, CD35, CD38, CD34, CD123, CD138, CD319, CD274 
    ##     CD279, CD57, CD16, CD196, CD276 
    ## citePCA_ 2 
    ## Positive:  CD35, CD40, CD196, HLA-DR, CD268, CD21, CD19, CD185, IgD, CD1d 
    ##     CD24, CD1c, CD69, CD305, CD267, CD14, CD58, CD64, CD86, CD11b 
    ##     CD38, CD154, CD34, CD307c, CD10, CD307e 
    ## Negative:  CD56, CD16, CD127, CD57, CD8a, CD27, CD117, CD94, CD4, CD85j 
    ##     CD307d, CD319, CD135, CD70, CD279, CD80, CD269, CD276, CD274, CD209 
    ##     CD95, CD11c, CD123, CD366, CD138 
    ## citePCA_ 3 
    ## Positive:  CD35, CD64, CD11b, CD305, CD69, CD38, CD185, CD21, IgD, CD268 
    ##     CD40, CD19, CD86, HLA-DR, CD14, CD11c, CD1d, CD24, CD58, CD95 
    ##     CD4, CD196, CD123, CD1c, CD94, CD366 
    ## Negative:  CD307d, CD276, CD80, CD279, CD274, CD269, CD209, CD307e, CD154, CD319 
    ##     CD138, CD34, CD307c, CD70, CD85j, CD8a, CD117, CD127, CD27, CD135 
    ##     CD56, CD10, CD16, CD57, CD267 
    ## citePCA_ 4 
    ## Positive:  CD16, CD56, CD38, CD57, CD305, CD319, CD307c, CD123, IgD, CD366 
    ##     HLA-DR, CD11c, CD10, CD94, CD40, CD276, CD267, CD85j, CD307d, CD34 
    ##     CD274, CD135, CD209, CD154, CD307e, CD86 
    ## Negative:  CD27, CD127, CD4, CD8a, CD279, CD95, CD35, CD70, CD64, CD1d 
    ##     CD196, CD69, CD14, CD117, CD58, CD80, CD11b, CD19, CD24, CD21 
    ##     CD269, CD138, CD1c, CD185, CD268 
    ## citePCA_ 5 
    ## Positive:  CD38, CD56, CD57, CD196, CD35, CD69, CD138, CD8a, CD11b, CD64 
    ##     CD1d, CD269, CD14, CD10, CD24, CD154, CD209, CD307d, CD117, CD34 
    ##     CD185, CD279, CD58, CD21, IgD, CD80 
    ## Negative:  CD123, CD319, HLA-DR, CD267, CD4, CD16, CD86, CD85j, CD11c, CD40 
    ##     CD307e, CD305, CD366, CD1c, CD274, CD127, CD94, CD27, CD19, CD307c 
    ##     CD268, CD95, CD70, CD276, CD135

    ## Harmony 1/10

    ## Harmony 2/10

    ## Harmony 3/10

    ## Harmony 4/10

    ## Harmony converged after 4 iterations

    ## Warning: Invalid name supplied, making object name syntactically valid. New object name is Seurat..ProjectDim.CITE.harmony_cite; see ?make.names for more details on syntax validity

## Weighted nearest neighbors (wnn) analysis

``` r
# Clear and free up memory
rm(normalized_object)
gc()
```

    ##            used  (Mb) gc trigger   (Mb)   max used   (Mb)
    ## Ncells  6415662 342.7   11137002  594.8   11137002  594.8
    ## Vcells 91101921 695.1  687669378 5246.6 1059885493 8086.3

``` r
# Find weighted nearest neighbors with RNA and CITE
wnn_obj <-
  FindMultiModalNeighbors(
    object = harmonized_object,
    reduction.list = list("harmony", "harmony_cite"),
    dims.list =
      list(
        seq(harmonized_object@misc$max_pca_dim),
        seq(harmonized_object@misc$max_pca_cite_dim)
      ),
    modality.weight.name = c("SCT.weight", "CITE.weight")
  ) |>
  # Make UMAP reduction on wnn graph
  RunUMAP(
    nn.name = "weighted.nn",
    reduction.name = "umap_wnn",
    reduction.key = "wnnUMAP_"
  )
```

    ## Calculating cell-specific modality weights

    ## Finding 20 nearest neighbors for each modality.

    ## Calculating kernel bandwidths

    ## Finding multimodal neighbors

    ## Constructing multimodal KNN graph

    ## Constructing multimodal SNN graph

    ## Warning: The default method for RunUMAP has changed from calling Python UMAP via reticulate to the R-native UWOT using the cosine metric
    ## To use Python UMAP via reticulate, set umap.method to 'umap-learn' and metric to 'correlation'
    ## This message will be shown once per session

    ## 21:51:05 UMAP embedding parameters a = 0.9922 b = 1.112

    ## 21:51:06 Commencing smooth kNN distance calibration using 16 threads

    ## 21:51:07 Initializing from normalized Laplacian + noise

    ## 21:51:07 Commencing optimization for 200 epochs, with 421128 positive edges

    ## 21:51:14 Optimization finished

## Clustering

``` r
# Clear and free up memory
rm(harmonized_object)
gc()
```

    ##            used  (Mb) gc trigger   (Mb)   max used   (Mb)
    ## Ncells  6451967 344.6   11137002  594.8   11137002  594.8
    ## Vcells 93677975 714.8  281669379 2149.0 1059885493 8086.3

``` r
# Leiden clustering at multiple resolutions
wnn_clust_obj <- wnn_obj %>%
  (function(seurat_obj) {
    obj <- as(object = seurat_obj@graphs$wsnn, Class = "dgCMatrix")
    input <- graph_from_adjacency_matrix(adjmatrix = obj, weighted = TRUE)
    clustering.results <- future_lapply(
      X = seq(0.2, 1.2, 0.2),
      FUN = function(r) {
        ids <- leiden(
          object = input,
          resolution_parameter = r,
          seed = 42,
          weights = NULL
        )
        names(x = ids) <- colnames(x = obj)
        ids <- GroupSmallClusters(ids = ids, SNN = obj, threshold = 20, verbose = TRUE)
        results <- list(factor(x = ids, levels = str_sort(unique(ids), numeric = TRUE)))
        names(x = results) <- paste0("res.", r)
        return(results)
      }
    )
    clustering.results <- as.data.frame(x = clustering.results)
    seurat_obj@meta.data[, paste0("wsnn.res.", seq(0.2, 1.2, 0.2))] <- clustering.results
    seurat_obj
  })
```

    ## 1 clusters with less than 20 cells identified. 8 final clusters.

    ## Warning: UNRELIABLE VALUE: One of the 'future.apply' iterations ('future_lapply-1') unexpectedly generated random numbers without declaring so. There is a risk that those random numbers are not statistically sound and the overall results might be invalid. To fix this, specify 'future.seed=TRUE'. This ensures that proper, parallel-safe random numbers are produced via the L'Ecuyer-CMRG method. To disable this check, use 'future.seed = NULL', or set option 'future.rng.onMisuse' to "ignore".

    ## 1 clusters with less than 20 cells identified. 13 final clusters.

    ## Warning: UNRELIABLE VALUE: One of the 'future.apply' iterations ('future_lapply-2') unexpectedly generated random numbers without declaring so. There is a risk that those random numbers are not statistically sound and the overall results might be invalid. To fix this, specify 'future.seed=TRUE'. This ensures that proper, parallel-safe random numbers are produced via the L'Ecuyer-CMRG method. To disable this check, use 'future.seed = NULL', or set option 'future.rng.onMisuse' to "ignore".

    ## 1 clusters with less than 20 cells identified. 15 final clusters.

    ## Warning: UNRELIABLE VALUE: One of the 'future.apply' iterations ('future_lapply-3') unexpectedly generated random numbers without declaring so. There is a risk that those random numbers are not statistically sound and the overall results might be invalid. To fix this, specify 'future.seed=TRUE'. This ensures that proper, parallel-safe random numbers are produced via the L'Ecuyer-CMRG method. To disable this check, use 'future.seed = NULL', or set option 'future.rng.onMisuse' to "ignore".

    ## 1 clusters with less than 20 cells identified. 17 final clusters.

    ## Warning: UNRELIABLE VALUE: One of the 'future.apply' iterations ('future_lapply-4') unexpectedly generated random numbers without declaring so. There is a risk that those random numbers are not statistically sound and the overall results might be invalid. To fix this, specify 'future.seed=TRUE'. This ensures that proper, parallel-safe random numbers are produced via the L'Ecuyer-CMRG method. To disable this check, use 'future.seed = NULL', or set option 'future.rng.onMisuse' to "ignore".

    ## 1 clusters with less than 20 cells identified. 19 final clusters.

    ## Warning: UNRELIABLE VALUE: One of the 'future.apply' iterations ('future_lapply-5') unexpectedly generated random numbers without declaring so. There is a risk that those random numbers are not statistically sound and the overall results might be invalid. To fix this, specify 'future.seed=TRUE'. This ensures that proper, parallel-safe random numbers are produced via the L'Ecuyer-CMRG method. To disable this check, use 'future.seed = NULL', or set option 'future.rng.onMisuse' to "ignore".

    ## 1 clusters with less than 20 cells identified. 21 final clusters.

    ## Warning: UNRELIABLE VALUE: One of the 'future.apply' iterations ('future_lapply-6') unexpectedly generated random numbers without declaring so. There is a risk that those random numbers are not statistically sound and the overall results might be invalid. To fix this, specify 'future.seed=TRUE'. This ensures that proper, parallel-safe random numbers are produced via the L'Ecuyer-CMRG method. To disable this check, use 'future.seed = NULL', or set option 'future.rng.onMisuse' to "ignore".

``` r
# Save data for next step
saveRDS(object = wnn_clust_obj, file = here("demo_data", "wnn_clust_obj.RDS"))
```

``` r
session_info()
```

    ## ─ Session info ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
    ##  setting  value
    ##  version  R version 4.1.2 (2021-11-01)
    ##  os       Ubuntu 20.04.3 LTS
    ##  system   x86_64, linux-gnu
    ##  ui       X11
    ##  language (EN)
    ##  collate  en_US.UTF-8
    ##  ctype    en_US.UTF-8
    ##  tz       Etc/UTC
    ##  date     2022-01-20
    ##  pandoc   2.14.0.3 @ /usr/lib/rstudio-server/bin/pandoc/ (via rmarkdown)
    ## 
    ## ─ Packages ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
    ##  package              * version  date (UTC) lib source
    ##  abind                  1.4-5    2016-07-21 [1] RSPM (R 4.1.0)
    ##  Biobase                2.54.0   2021-10-26 [1] Bioconductor
    ##  BiocGenerics           0.40.0   2021-10-26 [1] Bioconductor
    ##  BiocManager          * 1.30.16  2021-06-15 [1] RSPM (R 4.1.0)
    ##  BiocNeighbors        * 1.12.0   2021-10-26 [1] Bioconductor
    ##  BiocParallel         * 1.28.3   2021-12-09 [1] Bioconductor
    ##  bitops                 1.0-7    2021-04-24 [1] RSPM (R 4.1.0)
    ##  cachem                 1.0.6    2021-08-19 [1] RSPM (R 4.1.0)
    ##  callr                  3.7.0    2021-04-20 [1] RSPM (R 4.1.0)
    ##  cli                    3.1.0    2021-10-27 [1] RSPM (R 4.1.0)
    ##  cluster                2.1.2    2021-04-17 [2] CRAN (R 4.1.2)
    ##  codetools              0.2-18   2020-11-04 [2] CRAN (R 4.1.2)
    ##  colorspace             2.0-2    2021-06-24 [1] RSPM (R 4.1.0)
    ##  cowplot                1.1.1    2020-12-30 [1] RSPM (R 4.1.0)
    ##  crayon                 1.4.2    2021-10-29 [1] RSPM (R 4.1.0)
    ##  data.table             1.14.2   2021-09-27 [1] RSPM (R 4.1.0)
    ##  DelayedArray           0.20.0   2021-10-26 [1] Bioconductor
    ##  deldir                 1.0-6    2021-10-23 [1] RSPM (R 4.1.0)
    ##  desc                   1.4.0    2021-09-28 [1] RSPM (R 4.1.0)
    ##  devtools             * 2.4.3    2021-11-30 [1] RSPM (R 4.1.0)
    ##  digest                 0.6.29   2021-12-01 [1] RSPM (R 4.1.0)
    ##  dplyr                  1.0.7    2021-06-18 [1] RSPM (R 4.1.0)
    ##  ellipsis               0.3.2    2021-04-29 [1] RSPM (R 4.1.0)
    ##  evaluate               0.14     2019-05-28 [1] RSPM (R 4.1.0)
    ##  fansi                  1.0.2    2022-01-14 [1] RSPM (R 4.1.0)
    ##  fastmap                1.1.0    2021-01-25 [1] RSPM (R 4.1.0)
    ##  fitdistrplus           1.1-6    2021-09-28 [1] RSPM (R 4.1.0)
    ##  fs                     1.5.2    2021-12-08 [1] RSPM (R 4.1.0)
    ##  future               * 1.23.0   2021-10-31 [1] RSPM (R 4.1.0)
    ##  future.apply         * 1.8.1    2021-08-10 [1] RSPM (R 4.1.0)
    ##  generics               0.1.1    2021-10-25 [1] RSPM (R 4.1.0)
    ##  GenomeInfoDb           1.30.0   2021-10-26 [1] Bioconductor
    ##  GenomeInfoDbData       1.2.7    2022-01-20 [1] Bioconductor
    ##  GenomicRanges          1.46.1   2021-11-18 [1] Bioconductor
    ##  ggplot2                3.3.5    2021-06-25 [1] RSPM (R 4.1.0)
    ##  ggrepel                0.9.1    2021-01-15 [1] RSPM (R 4.1.0)
    ##  ggridges               0.5.3    2021-01-08 [1] RSPM (R 4.1.0)
    ##  glmGamPoi              1.6.0    2021-10-26 [1] Bioconductor
    ##  globals                0.14.0   2020-11-22 [1] RSPM (R 4.1.0)
    ##  glue                   1.6.0    2021-12-17 [1] RSPM (R 4.1.0)
    ##  goftest                1.2-3    2021-10-07 [1] RSPM (R 4.1.0)
    ##  gridExtra              2.3      2017-09-09 [1] RSPM (R 4.1.0)
    ##  gtable                 0.3.0    2019-03-25 [1] RSPM (R 4.1.0)
    ##  harmony              * 0.1.0    2021-06-02 [1] RSPM (R 4.1.0)
    ##  here                 * 1.0.1    2020-12-13 [1] RSPM (R 4.1.0)
    ##  htmltools              0.5.2    2021-08-25 [1] RSPM (R 4.1.0)
    ##  htmlwidgets            1.5.4    2021-09-08 [1] RSPM (R 4.1.0)
    ##  httpuv                 1.6.5    2022-01-05 [1] RSPM (R 4.1.0)
    ##  httr                   1.4.2    2020-07-20 [1] RSPM (R 4.1.0)
    ##  ica                    1.0-2    2018-05-24 [1] RSPM (R 4.1.0)
    ##  igraph               * 1.2.11   2022-01-04 [1] RSPM (R 4.1.0)
    ##  IRanges                2.28.0   2021-10-26 [1] Bioconductor
    ##  irlba                  2.3.5    2021-12-06 [1] RSPM (R 4.1.0)
    ##  jsonlite               1.7.3    2022-01-17 [1] RSPM (R 4.1.0)
    ##  KernSmooth             2.23-20  2021-05-03 [2] CRAN (R 4.1.2)
    ##  knitr                  1.37     2021-12-16 [1] RSPM (R 4.1.0)
    ##  later                  1.3.0    2021-08-18 [1] RSPM (R 4.1.0)
    ##  lattice                0.20-45  2021-09-22 [2] CRAN (R 4.1.2)
    ##  lazyeval               0.2.2    2019-03-15 [1] RSPM (R 4.1.0)
    ##  leiden               * 0.3.9    2021-07-27 [1] RSPM (R 4.1.0)
    ##  lifecycle              1.0.1    2021-09-24 [1] RSPM (R 4.1.0)
    ##  listenv                0.8.0    2019-12-05 [1] RSPM (R 4.1.0)
    ##  lmtest                 0.9-39   2021-11-07 [1] RSPM (R 4.1.0)
    ##  magrittr             * 2.0.1    2020-11-17 [1] RSPM (R 4.1.0)
    ##  MASS                   7.3-54   2021-05-03 [2] CRAN (R 4.1.2)
    ##  Matrix                 1.3-4    2021-06-01 [2] CRAN (R 4.1.2)
    ##  MatrixGenerics         1.6.0    2021-10-26 [1] Bioconductor
    ##  matrixStats            0.61.0   2021-09-17 [1] RSPM (R 4.1.0)
    ##  memoise                2.0.1    2021-11-26 [1] RSPM (R 4.1.0)
    ##  mgcv                   1.8-38   2021-10-06 [2] CRAN (R 4.1.2)
    ##  mime                   0.12     2021-09-28 [1] RSPM (R 4.1.0)
    ##  miniUI                 0.1.1.1  2018-05-18 [1] RSPM (R 4.1.0)
    ##  munsell                0.5.0    2018-06-12 [1] RSPM (R 4.1.0)
    ##  nlme                   3.1-153  2021-09-07 [2] CRAN (R 4.1.2)
    ##  parallelly             1.30.0   2021-12-17 [1] RSPM (R 4.1.0)
    ##  patchwork              1.1.1    2020-12-17 [1] RSPM (R 4.1.0)
    ##  pbapply                1.5-0    2021-09-16 [1] RSPM (R 4.1.0)
    ##  pillar                 1.6.4    2021-10-18 [1] RSPM (R 4.1.0)
    ##  pkgbuild               1.3.1    2021-12-20 [1] RSPM (R 4.1.0)
    ##  pkgconfig              2.0.3    2019-09-22 [1] RSPM (R 4.1.0)
    ##  pkgload                1.2.4    2021-11-30 [1] RSPM (R 4.1.0)
    ##  plotly                 4.10.0   2021-10-09 [1] RSPM (R 4.1.0)
    ##  plyr                   1.8.6    2020-03-03 [1] RSPM (R 4.1.0)
    ##  png                    0.1-7    2013-12-03 [1] RSPM (R 4.1.0)
    ##  polyclip               1.10-0   2019-03-14 [1] RSPM (R 4.1.0)
    ##  prettyunits            1.1.1    2020-01-24 [1] RSPM (R 4.1.0)
    ##  processx               3.5.2    2021-04-30 [1] RSPM (R 4.1.0)
    ##  promises               1.2.0.1  2021-02-11 [1] RSPM (R 4.1.0)
    ##  ps                     1.6.0    2021-02-28 [1] RSPM (R 4.1.0)
    ##  purrr                * 0.3.4    2020-04-17 [1] RSPM (R 4.1.0)
    ##  R6                     2.5.1    2021-08-19 [1] RSPM (R 4.1.0)
    ##  RANN                   2.6.1    2019-01-08 [1] RSPM (R 4.1.0)
    ##  rappdirs               0.3.3    2021-01-31 [1] RSPM (R 4.1.0)
    ##  RColorBrewer           1.1-2    2014-12-07 [1] RSPM (R 4.1.0)
    ##  Rcpp                 * 1.0.8    2022-01-13 [1] RSPM (R 4.1.0)
    ##  RcppAnnoy              0.0.19   2021-07-30 [1] RSPM (R 4.1.0)
    ##  RCurl                  1.98-1.5 2021-09-17 [1] RSPM (R 4.1.0)
    ##  remotes                2.4.2    2021-11-30 [1] RSPM (R 4.1.0)
    ##  reshape2               1.4.4    2020-04-09 [1] RSPM (R 4.1.0)
    ##  reticulate             1.23     2022-01-14 [1] RSPM (R 4.1.0)
    ##  rlang                  0.4.12   2021-10-18 [1] RSPM (R 4.1.0)
    ##  rmarkdown              2.11     2021-09-14 [1] RSPM (R 4.1.0)
    ##  ROCR                   1.0-11   2020-05-02 [1] RSPM (R 4.1.0)
    ##  rpart                  4.1-15   2019-04-12 [2] CRAN (R 4.1.2)
    ##  rprojroot              2.0.2    2020-11-15 [1] RSPM (R 4.1.0)
    ##  RSpectra               0.16-0   2019-12-01 [1] RSPM (R 4.1.0)
    ##  rstudioapi             0.13     2020-11-12 [1] RSPM (R 4.1.0)
    ##  Rtsne                  0.15     2018-11-10 [1] RSPM (R 4.1.0)
    ##  S4Vectors              0.32.3   2021-11-21 [1] Bioconductor
    ##  scales                 1.1.1    2020-05-11 [1] RSPM (R 4.1.0)
    ##  scattermore            0.7      2020-11-24 [1] RSPM (R 4.1.0)
    ##  sctransform            0.3.3    2022-01-13 [1] RSPM (R 4.1.0)
    ##  sessioninfo            1.2.2    2021-12-06 [1] RSPM (R 4.1.0)
    ##  Seurat               * 4.1.0    2022-01-14 [1] RSPM (R 4.1.0)
    ##  SeuratObject         * 4.0.4    2021-11-23 [1] RSPM (R 4.1.0)
    ##  shiny                  1.7.1    2021-10-02 [1] RSPM (R 4.1.0)
    ##  spatstat.core          2.3-2    2021-11-26 [1] RSPM (R 4.1.0)
    ##  spatstat.data          2.1-2    2021-12-17 [1] RSPM (R 4.1.0)
    ##  spatstat.geom          2.3-1    2021-12-10 [1] RSPM (R 4.1.0)
    ##  spatstat.sparse        2.1-0    2021-12-17 [1] RSPM (R 4.1.0)
    ##  spatstat.utils         2.3-0    2021-12-12 [1] RSPM (R 4.1.0)
    ##  stringi                1.7.6    2021-11-29 [1] RSPM (R 4.1.0)
    ##  stringr              * 1.4.0    2019-02-10 [1] RSPM (R 4.1.0)
    ##  SummarizedExperiment   1.24.0   2021-10-26 [1] Bioconductor
    ##  survival               3.2-13   2021-08-24 [2] CRAN (R 4.1.2)
    ##  tensor                 1.5      2012-05-05 [1] RSPM (R 4.1.0)
    ##  testthat               3.1.1    2021-12-03 [1] RSPM (R 4.1.0)
    ##  tibble                 3.1.6    2021-11-07 [1] RSPM (R 4.1.0)
    ##  tidyr                  1.1.4    2021-09-27 [1] RSPM (R 4.1.0)
    ##  tidyselect             1.1.1    2021-04-30 [1] RSPM (R 4.1.0)
    ##  usethis              * 2.1.5    2021-12-09 [1] RSPM (R 4.1.0)
    ##  utf8                   1.2.2    2021-07-24 [1] RSPM (R 4.1.0)
    ##  uwot                   0.1.11   2021-12-02 [1] RSPM (R 4.1.0)
    ##  vctrs                  0.3.8    2021-04-29 [1] RSPM (R 4.1.0)
    ##  viridisLite            0.4.0    2021-04-13 [1] RSPM (R 4.1.0)
    ##  withr                  2.4.3    2021-11-30 [1] RSPM (R 4.1.0)
    ##  xfun                   0.29     2021-12-14 [1] RSPM (R 4.1.0)
    ##  xtable                 1.8-4    2019-04-21 [1] RSPM (R 4.1.0)
    ##  XVector                0.34.0   2021-10-26 [1] Bioconductor
    ##  yaml                   2.2.1    2020-02-01 [1] RSPM (R 4.1.0)
    ##  zlibbioc               1.40.0   2021-10-26 [1] Bioconductor
    ##  zoo                    1.8-9    2021-03-09 [1] RSPM (R 4.1.0)
    ## 
    ##  [1] /usr/local/lib/R/site-library
    ##  [2] /usr/local/lib/R/library
    ## 
    ## ─ Python configuration ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
    ##  python:         /home/rstudio/.local/share/r-miniconda/envs/r-reticulate/bin/python
    ##  libpython:      /home/rstudio/.local/share/r-miniconda/envs/r-reticulate/lib/libpython3.8.so
    ##  pythonhome:     /home/rstudio/.local/share/r-miniconda/envs/r-reticulate:/home/rstudio/.local/share/r-miniconda/envs/r-reticulate
    ##  version:        3.8.12 | packaged by conda-forge | (default, Oct 12 2021, 21:57:06)  [GCC 9.4.0]
    ##  numpy:          /home/rstudio/.local/share/r-miniconda/envs/r-reticulate/lib/python3.8/site-packages/numpy
    ##  numpy_version:  1.21.5
    ##  numpy:          /home/rstudio/.local/share/r-miniconda/envs/r-reticulate/lib/python3.8/site-packages/numpy
    ##  
    ##  NOTE: Python version was forced by RETICULATE_PYTHON
    ## 
    ## ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
